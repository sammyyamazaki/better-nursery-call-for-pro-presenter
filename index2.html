<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="global_app_title_index">Elternruf</title>

<style>

    html {
      margin: 0;
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
      font-family: "SF Pro Display", Arial, sans-serif;

      background:
        url("images/background.png") no-repeat bottom right / 350px auto,
        linear-gradient(135deg, #667eea 0%, #764ba2 100%);

      color: #222;
      display: flex;
      justify-content: center;
      align-items: center;

      background-attachment: fixed;
    }

    .main {
        max-width: 1200px;
        margin: auto;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .left, .right {
        background: #fff;
        border-radius: 25px;
        padding: 25px;
        box-shadow: 0px 12px 35px rgba(0,0,0,0.18);
    }

    .left {
        flex: 2;
        min-width: 350px;
    }
    .right {
        flex: 1;
        min-width: 280px;
    }

    h1 {
        text-align: center;
        margin-top: 0;
    }

    #connectionStatus {
        text-align: center;
    }

    .status-ok {
        color: #0a0;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .status-fail {
        color: red;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .group-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
    }

    .group-btn {
        border: none;
        padding: 12px 20px;
        border-radius: 14px;
        background: #eee;
        font-size: 20px;
        cursor: pointer;
        transition: 0.15s;
        font-weight: bold;
    }
    .group-btn.active {
        color: white;
    }

    #numberInput {
        width: 100%;
        font-size: 28px;
        padding: 15px;
        border-radius: 12px;
        border: 3px solid #b9b9ff;
        margin-bottom: 20px;
        box-sizing: border-box;
        text-align: center;
    }

    #callBtn {
        width: 100%;
        font-size: 32px;
        padding: 18px;
        border-radius: 18px;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: 0.1s;
    }

    #callBtn:active {
        transform: scale(0.97);
    }

    .active-call {
        padding: 25px;
        margin-bottom: 20px;
        border-radius: 18px;
        color: white;
        font-size: 34px;
        font-weight: bold;
        text-align: center;
    }

    .style-1 { background: linear-gradient(135deg, #42e695, #3bb2b8); }
    .style-2 { background: linear-gradient(135deg, #f7971e, #ffd200); }
    .style-3 { background: linear-gradient(135deg, #ff6b6b, #d94a4a); }
    .style-4 { background: linear-gradient(135deg, #7a6ff0, #5a4ed0); }
    .style-5 { background: linear-gradient(135deg, #4db7ff, #2f8ad6); }
    .style-6 { background: linear-gradient(135deg, #ff7ec2, #e95aa4); }
    .style-7 { background: linear-gradient(135deg, #9bdc28, #7db81e); }
    .style-8 { background: linear-gradient(135deg, #ffce39, #d3a824); }
    .style-9 { background: linear-gradient(135deg, #45d9c2, #28b39b); }
    .style-10 { background: linear-gradient(135deg, #c87bff, #a25bd9); }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
    }
</style>
</head>
<body>

<div class="main">
    <div class="left">
        <h1 data-i18n="index_title_h1">ELTERN RUFEN</h1>
        <div id="connectionStatus"></div>
        <div id="langDebug" style="text-align:center;font-size:12px;opacity:.7;margin-bottom:10px;"></div>


        <div class="group-buttons" id="groupButtons"></div>

        <input
            id="numberInput"
            type="number"
            data-i18n-placeholder="index_input_placeholder_number"
            placeholder="Nummer eingeben..." />

        <button id="callBtn" data-i18n="index_button_call">ðŸ“£ Rufen</button>
    </div>

    <div class="right">
        <h2 data-i18n="index_active_numbers_title">Aktive Nummer</h2>
        <div id="activeList"></div>
    </div>
</div>

<audio id="sound-success" src="sounds/success.mp3"></audio>
<audio id="sound-error" src="sounds/error.mp3"></audio>

<script>
// ===============================
//   I18N â€“ externe JSON-Dateien
// ===============================

let I18N = {};
let CURRENT_LANG = "de";

function getLang() {
    const params = new URLSearchParams(window.location.search);
    const urlLang = params.get("lang");
    if (urlLang) return urlLang.toLowerCase();

    const browser = (navigator.language || navigator.userLanguage || "de").slice(0, 2).toLowerCase();
    return browser;
}

function t(key, fallback) {
    if (I18N && Object.prototype.hasOwnProperty.call(I18N, key)) {
        return I18N[key];
    }
    return fallback !== undefined ? fallback : key;
}

function applyTranslations() {
    // normale Texte
    document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        const txt = t(key, el.textContent);
        if (!txt) return;

        if (el.tagName === "TITLE") {
            document.title = txt;
        } else {
            el.textContent = txt;
        }
    });

    // Placeholder-Texte
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        const placeholder = t(key, el.getAttribute("placeholder"));
        if (placeholder) {
            el.setAttribute("placeholder", placeholder);
        }
    });
}

async function initI18n() {
    const lang = getLang();
    CURRENT_LANG = lang;

    async function loadLang(langCode) {
        const res = await fetch(`/i18n/${langCode}.json`, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
    }

    try {
        I18N = await loadLang(lang);
    } catch (e) {
        console.warn("Fehler beim Laden der Sprachdatei", lang, e);
        if (lang !== "de") {
            try {
                I18N = await loadLang("de");
                CURRENT_LANG = "de";
            } catch (e2) {
                console.warn("Fallback auf Deutsch fehlgeschlagen, verwende statische Texte.", e2);
                I18N = {};
            }
        } else {
            I18N = {};
        }
    }

    applyTranslations();
   // document.getElementById("langDebug").textContent = "LANG=" + CURRENT_LANG;

    //document.getElementById("connectionStatus").innerHTML =
    //    '<div class="status-ok">LANG=' + CURRENT_LANG + '</div>';

    

    // initialer Text fÃ¼r Verbindungsstatus (wird von loadState Ã¼berschrieben)
    const cs = document.getElementById("connectionStatus");
    if (cs && !cs.innerHTML) {
        cs.innerHTML = '<div class="status-fail">' +
            t("index_status_checking", "Verbindung zu ProPresenter wird geprÃ¼ft ...") +
            "</div>";
    }
}

// ===============================
//   Bisherige Logik
// ===============================

let groups = [];
let selectedGroup = null;
let connectionOK = false;

/* ------------------------------------------
   URL-PARAMETER auslesen: ?group=R
------------------------------------------- */
function getURLGroupParam() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get("group");   // z.B. "R"
}

/* ---------------------------
   Gruppen laden
---------------------------- */
async function loadGroups() {
    const r = await fetch("/groups");
    const data = await r.json();

    // Prefix IMMER auf genau 1 Zeichen kÃ¼rzen + in GroÃŸbuchstaben
    groups = (data.groups || []).map(g => {
        const raw = (g.prefix || "").toString().trim();
        const oneChar = raw ? raw.charAt(0).toUpperCase() : "";
        return {
            ...g,
            prefix: oneChar
        };
    });

    renderGroupButtons();
}

/* ---------------------------
   State laden
---------------------------- */
async function loadState() {
    const r = await fetch("/state");
    const data = await r.json();

    // Backend liefert weiterhin "ok"/"fail"
    connectionOK = data.connection === "ok";
    const statusEl = document.getElementById("connectionStatus");

    if (connectionOK) {
        statusEl.innerHTML =
            '<div class="status-ok">' +
            t("global_status_pp_ok", "ðŸŸ¢ ProPresenter verbunden") +
            "</div>";
    } else {
        statusEl.innerHTML =
            '<div class="status-fail">' +
            t("global_status_pp_fail", "ðŸ”´ Keine Verbindung") +
            "</div>";
    }

    renderActiveList(data.active || []);
    updateInputs();
}

/* ---------------------------
   Gruppen Buttons anzeigen
---------------------------- */
function renderGroupButtons() {
    const box = document.getElementById("groupButtons");
    box.innerHTML = "";

    const urlPrefix = getURLGroupParam();

    groups.forEach((g, i) => {
        const b = document.createElement("button");
        b.className = "group-btn";
        b.textContent = g.name;

        b.onclick = () => {
            selectedGroup = g;
            updateActiveGroup();
        };

        box.appendChild(b);

        // URL-Prefix zuerst
        if (urlPrefix && g.prefix === urlPrefix) {
            selectedGroup = g;
        }
    });

    // falls keine URL-Auswahl â†’ erste Gruppe nehmen
    if (!selectedGroup && groups.length > 0) {
        selectedGroup = groups[0];
    }

    updateActiveGroup();
}

function updateActiveGroup() {
    const buttons = document.querySelectorAll(".group-btn");

    buttons.forEach((btn, i) => {
        btn.className = "group-btn";
        if (groups[i] === selectedGroup) {
            btn.classList.add("active");
            btn.classList.add("style-" + selectedGroup.style);
        }
    });

    const callBtn = document.getElementById("callBtn");
    callBtn.className = "";
    if (selectedGroup) {
        callBtn.classList.add("style-" + selectedGroup.style);
    }
}

/* ---------------------------
   Aktive Calls
---------------------------- */
function renderActiveList(list) {
    const box = document.getElementById("activeList");
    box.innerHTML = "";

    list.forEach(item => {
        const prefix = item.charAt(0);
        const group = groups.find(g => g.prefix === prefix);

        const div = document.createElement("div");
        const styleId = group ? group.style : 1;
        div.className = "active-call style-" + styleId;
        div.textContent = item;

        div.onclick = async () => {
            const r = await fetch("/remove?num=" + encodeURIComponent(item), { method: "POST" });
            const data = await r.json();
            renderActiveList(data.active || []);
        };

        box.appendChild(div);
    });

    // Wenn keine aktiven Nummern â†’ Text anzeigen
    if (!list || list.length === 0) {
        const empty = document.createElement("div");
        empty.textContent = t("index_no_active_numbers", "Keine aktiven Nummern");
        box.appendChild(empty);
    }
}

/* ---------------------------
   Nummer rufen
---------------------------- */
document.getElementById("callBtn").onclick = async () => {
    if (!connectionOK) {
        document.getElementById("sound-error").play();
        return;
    }

    const input = document.getElementById("numberInput");
    const val = input.value.trim();
    if (!val || !selectedGroup) return;

    const finalCode = selectedGroup.prefix + val;

    const r = await fetch("/add?num=" + encodeURIComponent(finalCode), { method: "POST" });
    const data = await r.json();

    document.getElementById("sound-success").play();
    renderActiveList(data.active || []);

    input.value = "";
};

function updateInputs() {
    const disabled = !connectionOK;
    document.getElementById("numberInput").disabled = disabled;
    document.getElementById("callBtn").disabled = disabled;
}

/* Init */
(async function () {
    await initI18n();   // Sprache laden & anwenden (DE/EN)
    loadGroups();
    loadState();
    setInterval(loadState, 1500);
})();
</script>

</body>
</html>
